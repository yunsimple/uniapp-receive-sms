<template>
	<view>
		<view v-for="(item, index) in alertList">
			<u-alert-my class="u-alert-item" :title="item.title" :type="item.type" :closable="item.isClose" @click="description(index)" @close="closeAlert(item.id)"></u-alert-my>
		</view>
		<u-modal :show="modalShow" :title="modalTitle" :content="modalContent" @confirm="closeModal"></u-modal>
	</view>
</template>

<script>
	import {
		http
	} from '@/utils/request.js'
	var aCache = getApp().globalData.aCache
	export default {
		name: "u-my-notice",
		props: {
			
		},
		data() {
			return {
				alertList: [],
				modalShow: false,
				clickCurrent: 0,
				modalTitle: null,
				modalContent: null
				
			}
		},
		mounted() {
			let key = 'noticeList'
			if(aCache.has(key)){
				let filterData = this.filterCloseNotice(aCache.get(key))
				this.alertList = filterData
			}else{
				http.post('/notice').then(res=>{
					if (res.data.error_code === 0 && res.data.data) {
						let filterData = this.filterCloseNotice(res.data.data)
						this.alertList = filterData
						aCache.add(key, filterData)
					}
				}).catch(err=>{
					this.alertList = []
				})
			}
		},
		methods: {
			description(e){
				this.clickCurrent = e
				this.modalTitle = this.alertList[this.clickCurrent].title
				this.modalContent = this.alertList[this.clickCurrent].description
				this.modalShow = true
			},
			closeModal(){
				this.modalShow = false
			},
			//todo 关闭后localstorage标记，其他页面都不给予显示，直接下次请求，下次获取alertList数据时，遍历一下，看是否存在，否则关闭
			closeAlert(e){
				let key = 'noticeClose'
				let noticeClose = uni.getStorageSync(key)
				if(noticeClose){
					noticeClose.push(e)
					let set = new Set(noticeClose)
					noticeClose = Array.from(set)
				}else{
					noticeClose = [e]
				}
				uni.setStorage({
					key: key,
					data: noticeClose
				})
			},
			filterCloseNotice(noticeList){
				let noticeClose = uni.getStorageSync('noticeClose')
				if(noticeClose.length > 0){
					noticeClose.forEach((val,i)=>{
						for(var key in noticeList){
							if(noticeList[key].id === val){
								noticeList.splice(key,1)
							}
						}
					})
				}
				return noticeList
			}
		}
	}
</script>

<style>
	.u-alert-item {
		margin-top: 10rpx;
	}
</style>
